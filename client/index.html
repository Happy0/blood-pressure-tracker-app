<html>
    <script>

        // function onInput() {
        //     const file = document.getElementById("camera_input").files[0];

        //     //const blob = new Blob(file);

        //     const formData = new FormData();
        //     formData.append("image", file)

        //     console.log(file);
        //     console.log(formData)
            

        //     fetch("/run-ocr", {
        //         method: 'POST',
        //         body: formData
        //     }).then(resp => resp.text())
        //     .then(resp => {
        //         const elem = document.getElementById("p")
        //         var text = document.createTextNode(JSON.stringify(resp));
        //         elem.appendChild(text)  
        //     }).catch((e) => console.log(JSON.stringify(e)))

        // }

        navigator.mediaDevices
            .getUserMedia({video: {facingMode: 'environment'}, audio: false})
            .then((localMediaStream) => {
                const video = document.querySelector("video");
                video.srcObject = localMediaStream;

                const mediaStream = localMediaStream.getVideoTracks()[0]

                const intervalId = setInterval(() => {
                    const imageCapture = new ImageCapture(mediaStream);

                    const result = imageCapture.grabFrame()
                        //.then(r => r.arrayBuffer())
                        .then(async (imageBitmap) => {
                            const ocanvas = new OffscreenCanvas(imageBitmap.width, imageBitmap.height);
                            ocanvas.getContext('bitmaprenderer').transferFromImageBitmap(imageBitmap);
                            const blob = await ocanvas.convertToBlob({ type: 'image/png' });

                        const formData = new FormData();
                        formData.append("image", blob, "testaroonie.png")

                        console.log(formData)

                        fetch("/run-ocr", {
                            method: 'POST',
                            body: formData
                        })
                        .then(resp => {
                            const result = resp.json().then(respJson => {
                                const elem = document.getElementById("p")
                                var text = document.createTextNode(JSON.stringify(respJson));
                                elem.appendChild(text)

                                if (respJson.type === "Reading") {
                                    clearInterval(intervalId)
                                }
                            })
                        })
                    })
                }, 1000)
            })
    </script>
    <body>
        <video autoplay></video>
        <canvas></canvas>
        <!-- <input id="camera_input" type="file" name="image" accept="image/*" capture="environment" oninput="onInput()">Take a picture of a reading</input>
        <p id="p">This is some text</p> -->
        <p id="p"></p>
    </body>

</html>